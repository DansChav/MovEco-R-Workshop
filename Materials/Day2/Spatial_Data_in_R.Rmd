---
title: "Introduction to working with Spatial Data in R"
author: "Dana Seidel"
date: "January 4, 2017"
output: github_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

- Introduce movement data
- Vectors/rasters
- Spatial data in R (sf, sp libraries)
- Projections, transformations
- visualizing spatial data (mapview, ggplot +geom_sf)

#Introduction

Today we are going to dive into working with movement data in R. We will start by
introducing you to some of the packages available for spatial data, discussing the
format of different spatial 

This is an introduction to Spatial Analysis using the `sf` library in R.
Much of this code was developed by Jamie Afflerbach  for her own introduction 
to the `sf` library and spatial analysis in R (see her 
[spatial-analysis-R repo](https://github.com/jafflerbach/spatial-analysis-R)). I 
have adapted it here to work specifically with movement data. 

# Packages
# Vector Data - Simple Features
# Dplyr functions with sf objects
# Raster data 
# itersections, extractions
# spatial joins
# Projections and transformations
# Visualization


# Packages

```{r}
# developer's version
devtools::install_github("tidyverse/ggplot2") 
library(ggplot2)

#install.packages(c("sf", "mapview"))
library(tidyverse)
library(sf)
library(mapview)
```



The **sf** ("simple features") package is an R implementation of:  
 - a new spatial data class system in R  
 - functions for reading and writing spatial data  
 - tools for spatial operations on vectors  

# Vector Data
A representation of the world using points, lines, and
polygons. Vector models are useful for storing data that has discrete boundaries,
such as country borders, land parcels, and streets.

Often, stored as "shapefiles", .shp

![]("./../../images/albatross.png")






# Read in the data
**sf** objects usually have two classes - `sf` and `data.frame`.
Two main differences comparing to a regular `data.frame` object are 
spatial metadata (`geometry type`, `dimension`, `bbox`, `epsg (SRID)`, 
`proj4string`) and additional column - typically named `geom` or `geometry`.


```{r}
west_shp_sf <- st_read(dsn = "shapefiles", layer="wc_regions")  #read in

west_shp_sf %>% ggplot() + geom_sf()  # visualize

class(west_shp_sf)
```

# Attributes
**sf** objects can be used as a regular `data.frame` object in many operations

```{r}
nrow(west_shp_sf)
ncol(west_shp_sf)
```


## sf & dplyr

It also easy to use the **dplyr** package on `sf` objects:

`select()`

```{r select}

west_shp_sf %>%
  select.sf(rgn, rgn_key, geometry)

```

`filter()`

```{r filter}

west_shp_sf %>%
  filter(rgn == "Oregon")

```

`mutate()`

```{r mutate}

sf_out <- west_shp_sf %>%
  mutate(rgn_id = c(1:5),
         area_km2 = area_m2/1000000) #converting square meters to square kilometers

sf_out
```

# Union

You can merge all polygons into one using `st_union()`.
```{r st_union}

full_rgn  <- st_union(sf_out)

plot(full_rgn)

#try plotting with ggplot2

 # ggplot(full_rgn) +
 #   geom_sf()
```

This doesn't work because now the object is a single geometry object of class `sfc` which is not a data.frame that ggplot requires for plotting. To turn an `sfc` object back into an `sf` object use `st_sf()`.

```{r st_sf}

full_rgn <- st_union(sf_out) %>%
            st_sf(geometry = .)

 ggplot(full_rgn) +
   geom_sf()
```


## Raster Data
A representation of the world as a surface divided 
into a regular grid of cells. Raster models are useful for storing data that 
varies continuously, as in an aerial photograph, a satellite image, 
a surface of chemical concentrations, or an elevation surface.

Often, stored as "GeoTIFFs", .tif


# Projections

![]("./../../images/crs.png")


```{r}
library(raster)
npp <- raster( "rasters/annual_npp.tif")
plot(npp)
crs(npp)

plot(projectRaster(npp, crs = "+proj=lcc +lat_1=48 +lat_2=33 +lon_0=-100 +ellps=WGS84"))


```

# Mapview

```{r}
#mapview(west_shp_sf)

st_sample(west_shp_sf, 25) -> fish

#icon: http://leafletjs.com/examples/custom-icons/
fishIcon <- makeIcon("images/lumpsucker.jpg", 18,18)

leaflet(fish) %>% addTiles %>% addMarkers(icon=fishIcon)

#mapview(west_shp_sf)@map %>% addTiles %>%  addMarkers(data = fish, icon=fishIcon)

#%>% addFeatures(data = fish, icon = fishIcon)

```

# Visualize

```{r}
plot(west_shp_sf)
plot(st_geometry(west_shp_sf))
plot(west_shp_sf[1])
```


# Visualize with ggplot

`ggplot2` now has integrated functionality to plot sf objects using `geom_sf()`.

```{r}

#simplest plot
ggplot(west_shp_sf) +
  geom_sf()

```

This is useful to make sure your file looks correct but doesn't display any information about the data. We can plot these regions and fill each polygon based on the rgn_id.

```{r}
ggplot(west_shp_sf) +
  geom_sf(aes(fill = rgn))
```
