---
title: "Introduction to working with Spatial Data in R"
author: "Dana Seidel"
date: "January 4, 2017"
output: github_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Section Topics
- Spatial data in R (sf, sp libraries)
- Vectors/rasters
- Projections, transformations
- visualizing spatial data (mapview, ggplot +geom_sf)

# Introduction
Today we are going to get our first taste of working with movement data in R, but we will begin by
introducing you to spatial data analysis in R more generally. In this section we will
review some of the R packages available for handling spatial data, discuss the
format of different spatial data types, and explore how we can manipulate and visualize these
in R. 

Much of this code was originally developed by Jamie Afflerbach. For her own introduction 
to the `sf` library and spatial analysis in R (see her 
[spatial-analysis-R repo](https://github.com/jafflerbach/spatial-analysis-R)). I 
have adapted it here for the specific purposes of our workshop.

# Packages

Primarily we will be introducing the  **sf** ("simple features") package for working 
with simple spatial data. 

The **sf** library is an R implementation of:  
 - a new spatial data class system in R  
 - functions for reading and writing spatial data  
 - tools for spatial operations on vectors  
 
Ultimately this seeks to replace the older **sp**, **rgdal**, **rgeos** packages 
which formed the original toolset for working with spatial data in R. The **sf** library
replaces the S4 class structure used in **sp** with simple feature access - the current standard
across industry for organizing spatial data -- extending R's data.frame structure directly
to accept spatial geometry attributes and making it easier to manipulate spatial datasets
using tools like dplyr and the tidyverse. However, as this package is new and under 
developement there are times were we will switch back to the S4 class structure to play
nice with our movement packages. 

More information regarding this shift [here](https://www.r-consortium.org/blog/2017/01/03/simple-features-now-on-cran)

Spatial data comes in two forms:

1. Vector data
2. Raster data

With important differences across classes. 

## Vector Data
Vector models are a representation of the world using points, lines, and
polygons. This class is useful for storing data that has discrete boundaries,
such as country borders, land parcels, and streets.

Often, stored as "shapefiles", .shp

![]("./../../images/albatross.png")


## Raster Data
Raster models are a representation of the world as a surface divided 
into a regular grid of cells. These are useful for storing data that 
varies continuously, as in an aerial photograph, a satellite image, 
a surface of chemical concentrations, or an elevation surface.

Often, stored as "GeoTIFFs", .tif


The **sf** library is used to store vector data but when working with raster data
we will use operations from packages **raster** and **velox**. 

Later when we work with movement data we may find a need for other spatial packages in R
such as: **spatial**, the **adehabitat** packages, **maptools**, **mapview**, 
and the developers version of **ggplot2**. 

# Dplyr functions with sf objects
# Raster data 
# itersections, extractions
# spatial joins
# Projections and transformations
# Visualization

# Read in the data

```{r}
library(ggplot2)
#install.packages(c("sf", "mapview"))
library(tidyverse)
library(sf)
library(mapview)
```


**sf** objects usually have two classes - `sf` and `data.frame`.
Two main differences comparing to a regular `data.frame` object are 
spatial metadata (`geometry type`, `dimension`, `bbox`, `epsg (SRID)`, 
`proj4string`) and additional column - typically named `geom` or `geometry`.


```{r}
west_shp_sf <- st_read(dsn = "shapefiles", layer="wc_regions")  #read in

west_shp_sf %>% ggplot() + geom_sf()  # visualize

class(west_shp_sf)
```

# Attributes
**sf** objects can be used as a regular `data.frame` object in many operations

```{r}
nrow(west_shp_sf)
ncol(west_shp_sf)
```


## sf & dplyr

It also easy to use the **dplyr** package on `sf` objects:

`select()`

```{r select}

west_shp_sf %>%
  select.sf(rgn, rgn_key, geometry)

```

`filter()`

```{r filter}

west_shp_sf %>%
  filter(rgn == "Oregon")

```

`mutate()`

```{r mutate}

sf_out <- west_shp_sf %>%
  mutate(rgn_id = c(1:5),
         area_km2 = area_m2/1000000) #converting square meters to square kilometers

sf_out
```

# Union

You can merge all polygons into one using `st_union()`.
```{r st_union}

full_rgn  <- st_union(sf_out)

plot(full_rgn)

#try plotting with ggplot2

 # ggplot(full_rgn) +
 #   geom_sf()
```

This doesn't work because now the object is a single geometry object of class `sfc` which is not a data.frame that ggplot requires for plotting. To turn an `sfc` object back into an `sf` object use `st_sf()`.

```{r st_sf}

full_rgn <- st_union(sf_out) %>%
            st_sf(geometry = .)

 ggplot(full_rgn) +
   geom_sf()
```



# Projections

![]("./../../images/crs.png")


```{r}
library(raster)
npp <- raster( "rasters/annual_npp.tif")
plot(npp)
crs(npp)

plot(projectRaster(npp, crs = "+proj=lcc +lat_1=48 +lat_2=33 +lon_0=-100 +ellps=WGS84"))


```

# Mapview

```{r}
#mapview(west_shp_sf)

st_sample(west_shp_sf, 25) -> fish

#icon: http://leafletjs.com/examples/custom-icons/
fishIcon <- makeIcon("images/lumpsucker.jpg", 18,18)

leaflet(fish) %>% addTiles %>% addMarkers(icon=fishIcon)

#mapview(west_shp_sf)@map %>% addTiles %>%  addMarkers(data = fish, icon=fishIcon)

#%>% addFeatures(data = fish, icon = fishIcon)

```

# Visualize

```{r}
plot(west_shp_sf)
plot(st_geometry(west_shp_sf))
plot(west_shp_sf[1])
```


# Visualize with ggplot

`ggplot2` now has integrated functionality to plot sf objects using `geom_sf()`.

```{r}

#simplest plot
ggplot(west_shp_sf) +
  geom_sf()

```

This is useful to make sure your file looks correct but doesn't display any information about the data. We can plot these regions and fill each polygon based on the rgn_id.

```{r}
ggplot(west_shp_sf) +
  geom_sf(aes(fill = rgn))
```
